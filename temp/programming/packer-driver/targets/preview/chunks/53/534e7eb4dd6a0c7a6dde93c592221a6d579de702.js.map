{"version":3,"sources":["file:///C:/Users/maide/OneDrive/Documents/GitHub/match3-v100/assets/Scripts/Piece/Piece.ts"],"names":["Piece","Node","ParticleSystem2D","tween","Vec3","SelectionManager","GameGlobal","constructor","row","col","node","type","m_isEmpty","isMatched","particle","spriteNode","on","EventType","TOUCH_START","onTouch","getComponentInChildren","getChildByName","init","setPosition","isEmpty","console","log","getInstance","eventTarget","emit","_row","_col","PIECE_CONTENT_SIZE","PIECE_OFFSET","piecePostion","updatePosition","Promise","resolve","piecePosition","to","position","call","start","matched","resetSystem","playOnLoad","scale","clearPiece","Shake","shakeAmount","duration","originalPosition","getPosition","by","setSelection","Highlight","cancelSelection","ResetScale","easing","moveToPosition","newPos","startPos","clone","targetPos","x","y","z","onUpdate","target","ratio","currentPos","lerp","assingPiece","off"],"mappings":"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","sourcesContent":["import {\r\n  easing,\r\n  Node,\r\n  ParticleSystem2D,\r\n  removeProperty,\r\n  SpriteRenderer,\r\n  tween,\r\n  Vec3,\r\n} from \"cc\";\r\nimport { IPiece } from \"./IPiece\";\r\nimport { PieceTypes } from \"./PieceTypes\";\r\nimport { SelectionManager } from \"../Interaction/SelectionManager\";\r\nimport { GameGlobal } from \"../Game/GameGlobal\";\r\n\r\nexport class Piece implements IPiece {\r\n  public row: number = -1!;\r\n  public col: number = -1!;\r\n  public node: Node;\r\n  public type: PieceTypes = null;\r\n\r\n  private m_isEmpty = false;\r\n  public isMatched: boolean = false;\r\n  private particle: ParticleSystem2D = null;\r\n  private spriteNode: Node = null;\r\n  public constructor(row: number, col: number, node: Node, type: PieceTypes) {\r\n    this.row = row;\r\n    this.col = col;\r\n    this.node = node;\r\n    this.type = type;\r\n    this.node.on(Node.EventType.TOUCH_START, this.onTouch, this);\r\n    this.m_isEmpty = false;\r\n    this.particle = this.node.getComponentInChildren(ParticleSystem2D);\r\n    this.spriteNode = this.node.getChildByName(\"Sprite\");\r\n  }\r\n\r\n  init() {\r\n    this.setPosition(this.row, this.col);\r\n  }\r\n\r\n  onTouch() {\r\n    if (this.isEmpty) return;\r\n    console.log(this.row, this.col);\r\n\r\n    SelectionManager.getInstance().eventTarget.emit(\"piece-selected\", this);\r\n  }\r\n\r\n  public get isEmpty(): boolean {\r\n    const m_isEmpty = this.node ? false : true;\r\n    return m_isEmpty;\r\n  }\r\n\r\n  setPosition(_row: number, _col: number) {\r\n    const row =\r\n      _row * (GameGlobal.PIECE_CONTENT_SIZE + GameGlobal.PIECE_OFFSET);\r\n    const col =\r\n      _col * (GameGlobal.PIECE_CONTENT_SIZE + GameGlobal.PIECE_OFFSET);\r\n    const piecePostion = new Vec3(col, row);\r\n    this.node.setPosition(piecePostion);\r\n  }\r\n\r\n  updatePosition(_row = this.row, _col = this.col): Promise<void> {\r\n    return new Promise((resolve) => {\r\n      const row = _row * (GameGlobal.PIECE_CONTENT_SIZE + GameGlobal.PIECE_OFFSET);\r\n      const col = _col * (GameGlobal.PIECE_CONTENT_SIZE + GameGlobal.PIECE_OFFSET);\r\n      const piecePosition = new Vec3(col, row);\r\n\r\n      tween(this.node)\r\n        .to(0.1, { position: piecePosition })\r\n        .call(() => resolve())\r\n        .start();\r\n    });\r\n  }\r\n\r\n  async matched(): Promise<void> {\r\n    this.isMatched = true;\r\n    if (this.particle) {\r\n      this.particle.resetSystem();\r\n      this.particle.playOnLoad = true;\r\n    }\r\n    if (this.spriteNode) {\r\n      await new Promise<void>((resolve) => {\r\n        tween(this.spriteNode)\r\n          .to(0.2, { scale: new Vec3(0, 0, 0) })\r\n          .call(resolve)\r\n          .start();\r\n      });\r\n    }\r\n    this.clearPiece();\r\n  }\r\n\r\n  public async Shake(shakeAmount: number = 10, duration: number = 0.3) {\r\n    if (this.isEmpty) return;\r\n    const originalPosition = this.node?.getPosition();\r\n\r\n    return new Promise<void>((resolve) => {\r\n      if (this.node) {\r\n        tween(this.node)\r\n          .by(duration / 4, { position: new Vec3(shakeAmount, 0, 0) })\r\n          .by(duration / 4, { position: new Vec3(-shakeAmount * 2, 0, 0) })\r\n          .by(duration / 4, { position: new Vec3(shakeAmount * 2, 0, 0) })\r\n          .by(duration / 4, { position: new Vec3(-shakeAmount, 0, 0) })\r\n          .call(() => {\r\n            this.node?.setPosition(originalPosition);\r\n            resolve();\r\n          })\r\n          .start();\r\n      }\r\n    });\r\n  }\r\n\r\n  public setSelection(): Piece {\r\n    this.Highlight();\r\n    return this;\r\n  }\r\n\r\n  public cancelSelection() {\r\n    this.ResetScale();\r\n    return null;\r\n  }\r\n\r\n  public Highlight(\r\n    duration: number = 0.1,\r\n    scale: Vec3 = new Vec3(1.1, 1.1, 1.1)\r\n  ) {\r\n    tween(this.node)\r\n      .to(duration, { scale: scale }, { easing: \"expoOut\" })\r\n      .start();\r\n  }\r\n\r\n  public ResetScale(duration: number = 0.1) {\r\n    tween(this.node)\r\n      .to(duration, { scale: new Vec3(1, 1, 1) })\r\n      .start();\r\n  }\r\n\r\n  public moveToPosition(newPos: Vec3, duration: number = 0.2): Promise<void> {\r\n    return new Promise<void>((resolve) => {\r\n      const startPos = this.node.position.clone();\r\n      const targetPos = new Vec3(\r\n        newPos.x * (GameGlobal.PIECE_CONTENT_SIZE + GameGlobal.PIECE_OFFSET),\r\n        newPos.y * (GameGlobal.PIECE_CONTENT_SIZE + GameGlobal.PIECE_OFFSET),\r\n        newPos.z\r\n      );\r\n      tween(this.node)\r\n        .to(\r\n          duration,\r\n          { position: targetPos },\r\n          {\r\n            easing: \"quartOut\",\r\n            onUpdate: (target: Node, ratio: number) => {\r\n              const currentPos = new Vec3();\r\n              Vec3.lerp(currentPos, startPos, targetPos, ratio);\r\n              target.setPosition(currentPos);\r\n            },\r\n          }\r\n        )\r\n        .call(() => {\r\n          this.row = newPos.y;\r\n          this.col = newPos.x;\r\n          resolve();\r\n        })\r\n        .start();\r\n    });\r\n  }\r\n\r\n  public assingPiece(node: Node) {\r\n    this.node = node;\r\n    this.node.on(Node.EventType.TOUCH_START, this.onTouch, this);\r\n    this.particle = this.node.getComponentInChildren(ParticleSystem2D);\r\n    this.spriteNode = this.node.getChildByName(\"Sprite\");\r\n    this.isMatched = false;\r\n  }\r\n\r\n  public clearPiece() {\r\n    if (this.node) {\r\n      this.node.off(Node.EventType.TOUCH_START, this.onTouch, this);\r\n    }\r\n    this.node = null;\r\n    this.particle = null;\r\n    this.spriteNode = null;\r\n  }\r\n}\r\n"]}