{"version":3,"sources":["file:///C:/Users/maide/OneDrive/Documents/GitHub/match3-v100/assets/Scripts/Grid/GravityHandler.ts"],"names":["_decorator","GridManager","SingletonComponent","ccclass","property","GravityHandler","onLoad","applyGravity","grid","getInstance","console","log","col","length","row","node","movePieceDown","moved","piece","targetRow","findLowestEmptyRow","updatePosition","startRow"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Vec3 } from 'cc';\nimport { Piece } from '../Piece/Piece';\nimport { GridManager } from '../Grid/GridManager';\nimport { SingletonComponent } from \"../SingletonComponent\";\n\nconst { ccclass, property } = _decorator;\n\n@ccclass('GravityHandler')\nexport class GravityHandler extends SingletonComponent<GravityHandler> {\n\n    onLoad() {\n        super.onLoad();\n    }\n\n    async applyGravity() {\n        const grid = GridManager.getInstance().grid;\n        console.log(grid);\n        for (let col = 0; col < grid[0].length - 1; col++) {\n            for (let row = grid.length - 1; row > 0; row--) {\n                if ( grid[row][col].node !== null && grid[row - 1][col].node !== null) {\n                    console.log(\"aaaa\");\n                    \n                    await this.movePieceDown(row - 1, col , grid);\n                    // moved = true;\n                }\n            }\n        }\n        return;\n        let moved = false;\n        do {\n            moved = false;\n            for (let col = 0; col < grid[0].length; col++) {\n                for (let row = grid.length - 1; row > 0; row--) {\n                    if (grid[row][col] === null && grid[row - 1][col] !== null) {\n                        await this.movePieceDown(row - 1, col , grid);\n                        moved = true;\n                    }\n                }\n            }\n        } while (moved);\n\n        // await this.fillEmptySpaces();\n    }\n\n    async movePieceDown(row: number, col: number , grid : Piece[][]) {\n        const piece = grid[row][col];\n        if (piece) {\n            const targetRow = this.findLowestEmptyRow(col, row , grid);\n            console.log(targetRow);\n            \n            if (targetRow !== row) {\n                grid[targetRow][col].node = piece.node;\n                grid[row][col].node = null;\n\n                piece.row = targetRow;\n                console.log(piece);\n                \n                piece.updatePosition();\n                // await EffectManager.movePiece(piece.node, targetPos, 0.2);\n            }\n        }\n    }\n\n   \n    findLowestEmptyRow(col: number, startRow: number ,grid): number {\n        for (let row = grid.length - 1; row > startRow; row--) {\n            if (grid[row][col].node === null) {\n                return row;\n            }\n        }\n        return startRow;\n    }\n    /*\n\n    async fillEmptySpaces() {\n        for (let col = 0; col < grid[0].length; col++) {\n            let emptyCount = 0;\n            for (let row = 0; row < grid.length; row++) {\n                if (grid[row][col] === null) {\n                    emptyCount++;\n                }\n            }\n\n            for (let i = 0; i < emptyCount; i++) {\n                const newPieceNode = PiecePool.getInstance().getPiece();\n                if (!newPieceNode) {\n                    console.error(\"PiecePool could not provide a new piece.\");\n                    continue;\n                }\n\n                const targetRow = this.findLowestEmptyRow(col, -1);\n                const newPiece = new Piece(targetRow, col, newPieceNode);\n                grid[targetRow][col] = newPiece;\n\n                const startPos = gridManager.getPositionForCell(-1, col);\n                const targetPos = gridManager.getPositionForCell(targetRow, col);\n\n                newPiece.node.setPosition(startPos);\n                await EffectManager.movePiece(newPiece.node, targetPos, 0.2);\n            }\n        }\n    }\n         */\n}"]}